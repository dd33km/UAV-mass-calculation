# Техническая документация

## Архитектура приложения

Приложение построено по модульной архитектуре, где каждый модуль отвечает за определенную функциональность.

## Структура проекта

```
drone_calculator/
├── main.py                          # Точка входа в приложение
├── requirements.txt                 # Зависимости Python
├── README.md                        # Руководство пользователя
├── DOCUMENTATION.md                 # Техническая документация
├── README_CHANGES.md                # Описание последних изменений
├── test_application.py              # Тестовый скрипт
│
├── database/                        # Модуль базы данных
│   ├── __init__.py
│   ├── db_manager.py               # Менеджер базы данных
│   └── drone_components.db         # SQLite база данных
│
└── modules/                         # Модули приложения
    ├── __init__.py
    ├── calculator.py               # Логика расчетов
    ├── gui.py                      # Графический интерфейс
    ├── visualizer.py               # Визуализация данных
    └── report.py                   # Генерация отчетов
```

## Описание модулей

### 1. database/db_manager.py

**Класс:** `DatabaseManager`

**Назначение:** Управление SQLite базой данных, CRUD операции с компонентами и историей расчетов.

**Основные методы:**

```python
__init__(db_path: str)
    Инициализирует подключение к базе данных
    
_create_tables()
    Создает структуру таблиц
    
_populate_initial_data()
    Заполняет базу начальными данными
    
get_components(table_name: str) -> List[Dict]
    Получает все компоненты из таблицы
    
add_component(table_name: str, data: Dict) -> int
    Добавляет новый компонент
    
update_component(table_name: str, component_id: int, data: Dict)
    Обновляет данные компонента
    
delete_component(table_name: str, component_id: int)
    Удаляет компонент
    
save_calculation(calculation_data: Dict) -> int
    Сохраняет расчет в историю
    
get_calculation_history(limit: int) -> List[Dict]
    Получает историю расчетов
    
get_calculation_details(calc_id: int) -> Dict
    Получает детальную информацию о конкретном расчете
    
delete_calculation(calc_id: int)
    Удаляет расчет из истории
    
clear_history()
    Очищает всю историю расчетов
```

**Таблицы базы данных:**

1. **frames** - Корпуса дронов
   - id (INTEGER PRIMARY KEY)
   - name (TEXT NOT NULL)
   - mass (REAL NOT NULL)
   - description (TEXT)

2. **motors** - Двигатели
   - id (INTEGER PRIMARY KEY)
   - name (TEXT NOT NULL)
   - mass (REAL NOT NULL)
   - description (TEXT)

3. **batteries** - Аккумуляторы
   - id (INTEGER PRIMARY KEY)
   - name (TEXT NOT NULL)
   - mass (REAL NOT NULL)
   - capacity (INTEGER)
   - description (TEXT)

4. **flight_controllers** - Контроллеры полета
   - id (INTEGER PRIMARY KEY)
   - name (TEXT NOT NULL)
   - mass (REAL NOT NULL)
   - description (TEXT)

5. **propellers** - Пропеллеры
   - id (INTEGER PRIMARY KEY)
   - name (TEXT NOT NULL)
   - mass (REAL NOT NULL)
   - size (TEXT)
   - description (TEXT)

6. **cameras** - Камеры/полезная нагрузка
   - id (INTEGER PRIMARY KEY)
   - name (TEXT NOT NULL)
   - mass (REAL NOT NULL)
   - description (TEXT)

7. **calculations_history** - История расчетов
   - id (INTEGER PRIMARY KEY)
   - timestamp (TEXT NOT NULL)
   - frame_id, frame_name, frame_mass
   - motor_id, motor_name, motor_mass, motor_qty
   - battery_id, battery_name, battery_mass
   - fc_id, fc_name, fc_mass
   - propeller_id, propeller_name, propeller_mass, propeller_qty
   - camera_id, camera_name, camera_mass
   - total_mass (REAL NOT NULL)

### 2. modules/calculator.py

**Класс:** `DroneCalculator`

**Назначение:** Выполнение расчетов массы дрона и валидация данных.

**Основные методы:**

```python
validate_mass(mass: float) -> Tuple[bool, str]
    Проверяет корректность значения массы
    Возвращает: (валидность, сообщение об ошибке)
    
validate_quantity(quantity: int) -> Tuple[bool, str]
    Проверяет корректность количества
    Возвращает: (валидность, сообщение об ошибке)
    
calculate_component_mass(component_mass: float, quantity: int) -> float
    Вычисляет общую массу компонента с учетом количества
    
calculate_total_mass(components: Dict) -> Dict
    Вычисляет общую массу дрона
    Возвращает словарь с результатами:
    {
        'components': {...},
        'total_mass': float,
        'component_count': int
    }
    
get_mass_distribution(components: Dict) -> Dict[str, float]
    Получает распределение массы для диаграммы
    Возвращает: {название_компонента: масса}
    
format_mass(mass: float) -> str
    Форматирует массу для отображения
    
get_weight_category(total_mass: float) -> str
    Определяет категорию дрона по массе
```

**Алгоритм расчета:**

1. Валидация входных данных
2. Расчет массы каждого компонента: `масса_единицы * количество`
3. Суммирование всех компонентов
4. Определение категории дрона
5. Формирование результатов

### 3. modules/visualizer.py

**Класс:** `DroneVisualizer`

**Назначение:** Создание графиков и диаграмм для визуализации данных.

**Основные методы:**

```python
create_pie_chart(data: Dict, title: str) -> plt.Figure
    Создает круговую диаграмму распределения массы
    Параметры:
        data: {компонент: масса}
        title: заголовок диаграммы
    Возвращает: matplotlib Figure
    
create_bar_chart(data: Dict, title: str) -> plt.Figure
    Создает столбчатую диаграмму массы компонентов
    
embed_figure_in_tkinter(figure: plt.Figure, parent_frame) -> FigureCanvasTkAgg
    Встраивает matplotlib figure в tkinter frame
    Возвращает: Canvas объект или None если tkinter недоступен
```

**Особенности визуализации:**

- Темная тема для графиков
- Цветовое кодирование компонентов
- Отображение процентов и абсолютных значений
- Автоматическое форматирование подписей
- Диаграммы создаются только в памяти (без сохранения в файлы)
- Поддержка встраивания в tkinter интерфейс


### 4. modules/report.py

**Класс:** `ReportGenerator`

**Назначение:** Генерация текстовых отчетов о конфигурации дрона.

**Основные методы:**

```python
generate_text_report(calculation_results: Dict, calc_id: int) -> str
    Генерирует текстовый отчет
    Включает:
        - Дату и время
        - ID конфигурации
        - Детальный состав
        - Итоговые данные
        - Процентное распределение
        - Рекомендации
    
save_report_to_file(report_text: str, filename: str) -> str
    Сохраняет отчет в файл
    Возвращает: имя файла
```

**Структура отчета:**

1. **Заголовок** - название и разделители
2. **Информация о расчете** - дата, время, ID
3. **Состав конфигурации** - детали по каждому компоненту
4. **Итоговые данные** - общая масса, категория
5. **Процентное распределение** - доля каждого компонента
6. **Рекомендации** - советы на основе конфигурации

### 5. modules/gui.py

**Класс:** `DroneCalculatorGUI`

**Назначение:** Графический интерфейс пользователя на базе CustomTkinter.

**Основные компоненты:**

```python
__init__()
    Инициализация GUI и всех компонентов
    
_create_main_layout()
    Создает основную структуру с вкладками
    
_create_calculator_tab()
    Вкладка калькулятора:
        - Выбор компонентов
        - Поля количества
        - Кнопки расчета
        - Отображение результатов
        - Диаграмма
    
_create_components_tab()
    Вкладка управления компонентами:
        - Выбор типа компонента
        - Список компонентов
        - Добавление/редактирование
    
_create_history_tab()
    Вкладка истории расчетов:
        - Скроллируемый список расчетов
        - Каждый расчет отображается в двух колонках:
          * Левая: текстовая информация (ID, дата, масса, компоненты)
          * Правая: круговая диаграмма распределения массы
        - Кнопки обновления и очистки истории
    
_load_history()
    Загружает историю расчетов и создает визуальное представление
    Для каждого расчета:
        - Создает контейнер с двумя колонками
        - Отображает текстовую информацию слева
        - Генерирует и встраивает диаграмму справа
    
_calculate_mass()
    Выполняет расчет и обновляет интерфейс
    
run()
    Запускает главный цикл приложения
```

**Особенности интерфейса:**

- **CustomTkinter** - современные виджеты
- **Темная тема** - приятный для глаз дизайн
- **Адаптивный layout** - подстраивается под размер окна
- **Валидация в реальном времени** - проверка данных
- **Визуальная обратная связь** - цветовые индикаторы
- **Интуитивная навигация** - логичное расположение элементов
- **Встроенные диаграммы** - круговые диаграммы в истории расчетов


## Потоки данных

### Расчет массы

```
Пользователь выбирает компоненты
    ↓
GUI собирает данные
    ↓
Calculator валидирует данные
    ↓
Calculator вычисляет массу
    ↓
Visualizer создает диаграмму (в памяти)
    ↓
DatabaseManager сохраняет в историю
    ↓
GUI отображает результаты
```

### Добавление компонента

```
Пользователь заполняет форму
    ↓
GUI валидирует данные
    ↓
DatabaseManager добавляет в БД
    ↓
GUI обновляет списки
    ↓
Компонент доступен для выбора
```

### Генерация отчета

```
Пользователь запрашивает отчет
    ↓
ReportGenerator получает данные расчета
    ↓
ReportGenerator форматирует текст
    ↓
ReportGenerator добавляет рекомендации
    ↓
GUI отображает или сохраняет отчет
```

### Отображение истории (обновлено)

```
Пользователь открывает вкладку истории
    ↓
GUI запрашивает данные из DatabaseManager
    ↓
Для каждого расчета:
    ↓
    DatabaseManager предоставляет детали
    ↓
    Calculator формирует распределение массы
    ↓
    Visualizer создает диаграмму
    ↓
    GUI встраивает диаграмму в интерфейс
    ↓
GUI отображает все расчеты с диаграммами
```

## Обработка ошибок

### Валидация данных

- **Масса:** 0 < масса < 50000 г
- **Количество:** 0 < количество < 100
- **Обязательные поля:** проверка на пустые значения

### Обработка исключений

```python
try:
    # Операция с БД или расчет
except ValueError:
    # Некорректный формат данных
except sqlite3.Error:
    # Ошибка базы данных
except Exception as e:
    # Общая обработка ошибок
```

### Пользовательские сообщения

- **Ошибки:** красные диалоги с описанием проблемы
- **Предупреждения:** желтые диалоги с советами
- **Успех:** зеленые диалоги с подтверждением

## Производительность

### Оптимизации

1. **Ленивая загрузка** - компоненты загружаются по требованию
2. **Кэширование** - результаты расчетов сохраняются
3. **Индексы БД** - быстрый поиск по ID
4. **Пакетные операции** - группировка запросов к БД
5. **Диаграммы в памяти** - без создания временных файлов

### Ограничения

- **Максимум компонентов в БД:** ~10000 на таблицу
- **История расчетов:** рекомендуется до 50 записей (из-за диаграмм)
- **Размер отчета:** до 100 КБ текста
- **Память для диаграмм:** ~1-2 МБ на диаграмму

### Рекомендации по производительности

- При большой истории (>50 записей) рекомендуется периодическая очистка
- Диаграммы генерируются динамически при открытии вкладки истории
- Для ускорения загрузки можно реализовать пагинацию истории

## Расширяемость

### Добавление новых типов компонентов

1. Создать таблицу в `db_manager.py`
2. Добавить в `_populate_initial_data()`
3. Обновить `_get_table_name()` в GUI
4. Добавить селектор в `_create_calculator_tab()`

### Добавление новых форматов отчетов

1. Создать метод в `ReportGenerator`
2. Добавить кнопку экспорта в GUI
3. Реализовать логику форматирования

### Интеграция с внешними API

1. Создать новый модуль в `modules/`
2. Добавить методы получения данных
3. Интегрировать в существующие потоки

## Тестирование

### Модульные тесты (test_application.py)

Приложение включает автоматизированный тестовый скрипт, который проверяет все модули:

```python
# Запуск всех тестов
python test_application.py
```

**Тестируемые модули:**

1. **База данных** - создание, CRUD операции, удаление
2. **Калькулятор** - валидация, расчеты, форматирование
3. **Визуализация** - создание диаграмм (без сохранения в файлы)
4. **Генерация отчетов** - создание и сохранение отчетов

**Важно:** Тесты визуализации больше не создают временные файлы изображений.

### Интеграционные тесты

- Проверка взаимодействия модулей
- Тестирование потоков данных
- Валидация сохранения в БД

### UI тесты

- Проверка отклика интерфейса
- Тестирование валидации форм
- Проверка отображения результатов
- Проверка встраивания диаграмм

## Безопасность

### SQL Injection

- Использование параметризованных запросов
- Валидация всех входных данных
- Экранирование специальных символов

### Целостность данных

- Транзакции для критических операций
- Проверка ограничений БД
- Резервное копирование

## Развертывание

### Требования к системе

- **ОС:** Windows 10+, Linux, macOS
- **Python:** 3.8+
- **RAM:** 512 МБ минимум (1 ГБ рекомендуется для работы с диаграммами)
- **Диск:** 100 МБ свободного места
- **GUI:** Требуется графическая среда (X11, Wayland, Windows, macOS)

### Упаковка приложения

```bash
# PyInstaller для создания exe
pip install pyinstaller
pyinstaller --onefile --windowed main.py
```

### Обновления

1. Проверка версии БД
2. Миграция данных при необходимости
3. Обновление зависимостей
4. Тестирование совместимости

## Контрибьюция

### Стиль кода

- **PEP 8** для Python
- **Docstrings** для всех функций
- **Type hints** где возможно
- **Комментарии** на русском языке

### Процесс разработки

1. Fork репозитория
2. Создание feature branch
3. Разработка и тестирование
4. Pull request с описанием изменений
5. Code review
6. Merge в main


### Версия 1.0

- Первый релиз
- Базовая функциональность калькулятора
- Управление компонентами
- История расчетов
- Генерация отчетов

---

**Версия документации:** 1.0
**Статус:** Бета версия